<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ONLYOFFICE –î–æ–∫—É–º–µ–Ω—Ç—ã</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .user-select {
      margin: 15px 0;
      padding: 10px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    button, a { display: inline-block; margin: 5px 10px 5px 0; padding: 8px 16px; }
    ul { margin-top: 20px; }
    li { margin: 0px 0; }
    a { margin: 0;}
    .file-actions {
      margin: 0px 15px 0px 15px;
    }
    .file-name {
      margin-right: 15px;
      font-weight: 10;
    }
    .file-actions button {
      border: none;
      cursor: pointer;
      font-size: 1.1em;
      padding: 4px;
      margin: 0px;
      border-radius: 4px;
    }
    .file-actions button:hover {
      background-color: #f0f0f0;
}
  </style>
</head>
<body>
  <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
  <div class="user-select">
    <label><input type="radio" name="user" value="1" onchange="saveUser()"> –ê–ù</label>
    <label><input type="radio" name="user" value="2" onchange="saveUser()"> –ù–ù</label>
    <label><input type="radio" name="user" value="3" onchange="saveUser()"> –ê–ê</label>
  </div>

  <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç</h2>
  <a href="#" onclick="createDoc('text')"><button>üìÑ –¢–µ–∫—Å—Ç</button></a>
  <a href="#" onclick="createDoc('spreadsheet')"><button>üìä –¢–∞–±–ª–∏—Ü–∞</button></a>
  <a href="#" onclick="createDoc('presentation')"><button>üìΩÔ∏è –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è</button></a>

  <h2>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>
  <table>
    {{if and (ne .Dir "/") (ne .Dir "")}}
    <tr>
      <td>‚¨ÜÔ∏è</td>
      <td><a href="#" onclick="goUp(); return false;">–ù–∞–∑–∞–¥ '{{.Dir}}'</a></td>
    </tr>
    {{end}}

    {{range .Files}}  
    <tr>
      <td>
        {{if .IsDir}}üìÅ
        {{else}}
          <!--–ò–∫–æ–Ω–∫–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é -->
          {{if or (hasSuffix .Name ".doc") (hasSuffix .Name ".docx")}} üìÑ
          {{else if or (hasSuffix .Name ".xls") (hasSuffix .Name ".xlsx")}} üìä
          {{else if hasSuffix .Name ".pdf"}} üìÑ
          {{else if hasSuffix .Name ".zip"}} üóúÔ∏è
          {{else if hasSuffix .Name ".txt"}} üìù
          {{else}} üìé <!-- –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª -->
          {{end}}
        {{end}}
      </td>
      <td><a href="{{.Path}}">{{.Name}}</a></td>
      <td>
        {{if .IsDir}}</a>
        {{else}}
          <span class="file-actions">          
          <button type="button" onclick='previewFile("{{.Path}}")' title="–ü—Ä–æ—Å–º–æ—Ç—Ä">üëÅÔ∏è</button><!--
            {{if or 
              (or (hasSuffix .Name ".doc") (hasSuffix .Name ".docx"))
              (or (hasSuffix .Name ".xls") (hasSuffix .Name ".xlsx"))
            }}
          --><button type="button" onclick='editDoc("{{.Path}}")' title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" >‚úèÔ∏è</button><!--
            {{end}}
            
          --><button type="button" onclick='downloadFile("{{.Path}}")' title="–°–∫–∞—á–∞—Ç—å">üì•</button><!--
          --><button type="button" onclick='showInfo("{{.Path}}")' title="–ò–Ω—Ñ–æ">‚ÑπÔ∏è</button>
          </span>
        {{end}}
      </td>      
      <td>{{formatTime .ModTime}}</td>
    </tr>
  {{end}}
  </table>
<script>
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç {id, name}
  const users = {
    "1": "–ê–ù",
    "2": "–ù–ù",
    "3": "–ê–ê"
  };

  document.addEventListener("DOMContentLoaded", function() {
    const saved = localStorage.getItem("onlyofficeUserId");
    if (saved && users[saved]) {
      document.querySelector(`input[name="user"][value="${saved}"]`).checked = true;
    } else {
      // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ê–ù (id=1)
      document.querySelector('input[name="user"][value="1"]').checked = true;
    }
  });

  function saveUser() {
    const selected = document.querySelector('input[name="user"]:checked');
    if (selected) {
      localStorage.setItem("onlyofficeUserId", selected.value);
    }
  }

  function getUserId() {
    return localStorage.getItem("onlyofficeUserId") || "1";
  }

  function getUserName() {
    const id = getUserId();
    return users[id] || "–ê–ù";
  }

  function createDoc(type) {
    const userId = getUserId();
    const username = getUserName()
    window.location.href = `/create?type=${type}&userId=${userId}&username=${username}`;
  }

  function previewFile(path) {
    const previewUrl = `/preview?path=${encodeURIComponent(path)}`;
    window.open(previewUrl, '_blank');
  }

  function editDoc(filename) {
    const userId = getUserId();
    const username = getUserName()
    const editUrl = `/edit?file=${encodeURIComponent(filename)}&userId=${userId}&username=${username}`;
    window.open(editUrl, '_blank');
  }

  // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
  function downloadFile(path) {
    // –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Å—Å—ã–ª–∫–µ ‚Äî –±—Ä–∞—É–∑–µ—Ä —Å–∫–∞—á–∞–µ—Ç —Ñ–∞–π–ª
    window.location.href = path;
  }

  // –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–∞–π–ª–µ
  function showInfo(path) {
    fetch(`/info?path=${encodeURIComponent(path)}`)
      .then(res => res.json())
      .then(data => {
        let info = `–§–∞–π–ª: ${data.name}\n`;
        info += `–†–∞–∑–º–µ—Ä: ${data.size} –±–∞–π—Ç\n`;
        info += `–ò–∑–º–µ–Ω—ë–Ω: ${data.mod_time}\n`;
        info += `–•–µ—à: ${data.sha256 || '‚Äî'}\n`;
        alert(info);
      })
      .catch(err => {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é');
        console.error(err);
      });
  }
  /**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–±–µ–∑ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ / –∏ –±–µ–∑ query/hash)
 * –ü—Ä–∏–º–µ—Ä—ã:
 *   /docs/2024/       ‚Üí "docs/2024/"
 *   /docs/report.pdf  ‚Üí "docs/"
 *   /                 ‚Üí ""
 */
function getCurrentPath() {
    const path = window.location.pathname;
    // –£–±–∏—Ä–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π / –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º: —É–±–∏—Ä–∞–µ–º —Ñ–∞–π–ª, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    let clean = path.startsWith('/') ? path.slice(1) : path;
    if (clean === '') return '';

    return clean;
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤–≤–µ—Ä—Ö
 * –ü—Ä–∏–º–µ—Ä—ã:
 *   "docs/2024/" ‚Üí "docs/"
 *   "docs/"      ‚Üí ""
 *   ""           ‚Üí null (–∫–æ—Ä–µ–Ω—å)
 */
function getParentPath() {
    const current = getCurrentPath();
    if (!current) return null; // —É–∂–µ –≤ –∫–æ—Ä–Ω–µ

    // –£–¥–∞–ª—è–µ–º –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π /
    let trimmed = current.endsWith('/') ? current.slice(0, -1) : current;
    // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç
    const lastSlash = trimmed.lastIndexOf('/');
    if (lastSlash === -1) {
        return ''; // –±—ã–ª –æ–¥–∏–Ω —Å–µ–≥–º–µ–Ω—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä "docs/" ‚Üí ""
    }
    return trimmed.substring(0, lastSlash);
}

/**
 * –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤–≤–µ—Ä—Ö
 */
function goUp() {
    const parent = getParentPath();
    if (parent === "/d") {
        console.warn('Already at root');
        return;
    }
    // –§–æ—Ä–º–∏—Ä—É–µ–º URL: / + parent (–µ—Å–ª–∏ parent –ø—É—Å—Ç–æ–π ‚Äî –±—É–¥–µ—Ç /)
    const url = '/' + parent;
    window.location.href = url;
}
</script>
</body>
</html>